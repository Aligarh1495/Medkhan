{% extends 'products/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block meta_description %}
<meta name="description" content="Опытные врачи-специалисты клиники МедХан: урологи, гинекологи, неврологи, терапевты. Запись на прием онлайн. Набережные Челны, 52-й комплекс, 20А">
{% endblock %}

{% block meta_keywords %}
<meta name="keywords" content="врачи, специалисты, уролог, гинеколог, невролог, терапевт, хирург, проктолог, Набережные Челны, МедХан, запись к врачу">
{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "MedicalOrganization",
  "name": "МедХан",
  "description": "Команда опытных врачей-специалистов в клинике МедХан",
  "url": "{{ request.build_absolute_uri }}",
  "telephone": "+7 (901) 143-34-34",
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "52-й комплекс, 20А",
    "addressLocality": "Набережные Челны",
    "addressRegion": "Республика Татарстан",
    "addressCountry": "RU"
  },
  "employee": [
    {% for doctor in doctors %}
    {
      "@type": "Person",
      "name": "{{ doctor.full_name }}",
      "jobTitle": "{{ doctor.category }}",
      "worksFor": {
        "@type": "MedicalOrganization",
        "name": "МедХан"
      }
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ]
}
</script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/style8.css' %}">
{% endblock %}

{% block content %}
<!-- Секция специалистов -->
<section class="specialists-section" id="specialists" aria-labelledby="specialists-heading">
    <div class="container">
        <nav class="breadcrumbs" aria-label="Навигация по сайту">
            <a href="{% url 'main' %}">Главная</a> / <span>Специалисты</span>
        </nav>

        <header class="section-header">
            <h1 id="specialists-heading">Команда специалистов</h1>
            <div class="filters" role="group" aria-label="Фильтры поиска врачей">
                <div class="filter-dropdown">
                    <label for="gender-filter" class="sr-only">Фильтр по полу врача</label>
                    <select id="gender-filter" aria-label="Выберите пол врача">
                        <option value="">Пол</option>
                        <option value="male">Мужчина</option>
                        <option value="female">Женщина</option>
                    </select>
                </div>
                <div class="filter-dropdown">
                    <label for="specialization-filter" class="sr-only">Фильтр по специализации</label>
                    <select id="specialization-filter" aria-label="Выберите специализацию">
                        <option value="">Специализация</option>
                        {# Здесь можно динамически выводить специализации из БД, если они есть в отдельной модели #}
                        <option value="Невролог">Невролог</option>
                        <option value="Уролог">Уролог</option>
                        <option value="Гинеколог">Гинеколог</option>
                        <option value="Терапевт">Терапевт</option>
                        <option value="Хирург">Хирург</option>
                        <option value="Проктолог">Проктолог</option>
                        <option value="Андролог">Андролог</option>
                        <option value="Врач УЗИ">Врач УЗИ</option>
                        <option value="Кардиолог">Кардиолог</option>
                        <option value="Эндоскопист">Эндоскопист</option>
                        <option value="Врач функциональной диагностики">Врач функциональной диагностики</option>
                    </select>
                </div>
                <div class="search-bar" role="search">
                    <label for="doctor-search" class="sr-only">Поиск врача по имени</label>
                    <input type="text" placeholder="Поиск" id="doctor-search" aria-describedby="search-help">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M9 16C13.4183 16 17 12.4183 17 8C17 3.58172 13.4183 0 9 0C4.58172 0 1 3.58172 1 8C1 12.4183 4.58172 16 9 16Z" stroke="#999999" stroke-width="2"/>
                        <path d="M15 14L19 18" stroke="#999999" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <div id="search-help" class="sr-only">Введите имя врача для поиска</div>
                </div>
            </div>
        </header>

        <!-- Алфавитный фильтр -->
        <div class="alphabet-filter" role="group" aria-label="Алфавитный фильтр врачей">
            <button class="alphabet-btn active" data-letter="" aria-pressed="true">Все</button>
            {% for letter in "АБВГДЕЖЗИКЛМНОПРСТУФХЦЧШЩЭЮЯ" %}
            <button class="alphabet-btn" data-letter="{{ letter }}" aria-pressed="false">{{ letter }}</button>
            {% endfor %}
        </div>

        <div class="specialists-grid" role="list" aria-label="Список врачей-специалистов">
            {% for doctor in doctors %}
            <article class="specialist-card"
                     data-gender="{{ doctor.gender|default:'' }}" {# Предполагаем, что у врача может быть пол #}
                     data-specialization="{{ doctor.category|default:'' }}"
                     data-doctor-name="{{ doctor.full_name }}"
                     role="listitem">
                <div class="specialist-image">
                    {# Ссылка на динамическую страницу врача при клике на фото #}
                    <a href="{% url 'dynamic_doctor_profile' doctor.id %}" aria-label="Профиль врача {{ doctor.full_name }}">
                        <img src="{% if doctor.image %}{{ doctor.image.url }}{% else %}/placeholder.svg?height=250&width=250&query=doctor%20{{ doctor.full_name }}{% endif %}"
                             alt="Фото врача {{ doctor.full_name }}, {{ doctor.category|default:'Специалист' }}" loading="lazy">
                        <div class="experience-badge">Стаж {{ doctor.experience_years }} лет</div>
                    </a>
                </div>
                <div class="specialist-info">
                    <h3>{{ doctor.full_name|linebreaksbr }}</h3> {# Используем linebreaksbr для переноса строк #}
                    <p class="specialist-position">{{ doctor.category|default:"Специалист" }}</p>
                    {% if doctor.online_booking_link %}
                    <a href="{{ doctor.online_booking_link }}" target="_blank" class="btn btn-primary appointment-btn" aria-label="Записаться к врачу {{ doctor.full_name }}">Записаться</a>
                    {% else %}
                    {# Если ссылки нет, можно показать кнопку, которая открывает общую форму записи или модальное окно #}
                    <button class="btn btn-primary appointment-btn" onclick="alert('Онлайн-запись для этого врача пока недоступна.')" aria-label="Записаться к врачу {{ doctor.full_name }}">Записаться</button>
                    {% endif %}
                </div>
            </article>
            {% empty %}
            <p>Врачи не найдены.</p>
            {% endfor %}
        </div>

        <div class="show-more">
            <button class="btn btn-secondary" aria-label="Показать больше врачей">Показать ещё</button>
        </div>
    </div>
</section>

<!-- Модальное окно записи к врачу (оставлено, но кнопка "Записаться" теперь ведет на внешнюю ссылку) -->
<div id="appointmentModal" class="modal" role="dialog" aria-labelledby="modal-title" aria-hidden="true">
    <div class="modal-content">
        <header class="modal-header">
            <h2 id="modal-title" class="sr-only">Запись на приём к врачу</h2>
            <div class="modal-search" role="search">
                <label for="modal-search-input" class="sr-only">Поиск врача</label>
                <input type="text" placeholder="Поиск" id="modal-search-input">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M9 16C13.4183 16 17 12.4183 17 8C17 3.58172 13.4183 0 9 0C4.58172 0 1 3.58172 1 8C1 12.4183 4.58172 16 9 16Z" stroke="#999999" stroke-width="2"/>
                    <path d="M15 14L19 18" stroke="#999999" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
            <fieldset class="gender-filters">
                <legend class="sr-only">Фильтр по полу врача</legend>
                <label class="gender-option">
                    <input type="checkbox" checked>
                    <span>Все</span>
                </label>
                <label class="gender-option">
                    <input type="checkbox">
                    <span>Мужчина</span>
                </label>
                <label class="gender-option">
                    <input type="checkbox">
                    <span>Женщина</span>
                </label>
            </fieldset>
            <button type="button" class="modal-close" aria-label="Закрыть окно записи" onclick="closeAppointmentModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </header>

        <div class="modal-body">
            <div class="specializations-list" role="group" aria-label="Список специализаций">
                <label class="specialization-item">
                    <input type="checkbox">
                    <span>Абдоминальный хирург</span>
                </label>
                <label class="specialization-item">
                    <input type="checkbox">
                    <span>Акушер-гинеколог</span>
                </label>
                <label class="specialization-item">
                    <input type="checkbox">
                    <span>Аллерголог-иммунолог</span>
                </label>
                <label class="specialization-item">
                    <input type="checkbox">
                    <span>Аллерголог</span>
                </label>
                <label class="specialization-item">
                    <input type="checkbox">
                    <span>Андролог</span>
                </label>
            </div>

            <div class="appointment-section">
                <h3>Запись на приём к врачу</h3>
                <div class="doctor-info">
                    <img src="{% static 'images/specialist-4.png' %}" alt="Фото врача Башарова Альбина Шарипяновна" class="doctor-avatar" loading="lazy">
                    <div class="doctor-details">
                        <h4>Башарова<br>Альбина Шарипяновна</h4>
                        <p>Врач УЗИ, врач функциональной диагностики, кардиолог, терапевт</p>
                    </div>
                </div>

                <div class="clinic-location">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M10 2C7.79086 2 6 3.79086 6 6C6 8.20914 7.79086 10 10 10C12.2091 10 14 8.20914 14 6C14 3.79086 12.2091 2 10 2Z" stroke="#00C087" stroke-width="2"/>
                        <path d="M10 18C10 18 16 12 16 6C16 2.68629 13.3137 0 10 0C6.68629 0 4 2.68629 4 6C4 12 10 18 10 18Z" stroke="#00C087" stroke-width="2"/>
                    </svg>
                    <div>
                        <strong>МедХан</strong>
                        <address>Набережные Челны, 52-й комплекс, 20А</address>
                    </div>
                </div>

                <div class="services-prices" role="list" aria-label="Стоимость услуг">
                    <div class="service-item" role="listitem">
                        <span>Врач УЗИ</span>
                        <span>от 2500 ₽</span>
                    </div>
                    <div class="service-item" role="listitem">
                        <span>Врач функциональной диагностики</span>
                        <span>от 2500 ₽</span>
                    </div>
                    <div class="service-item" role="listitem">
                        <span>Кардиолог</span>
                        <span>от 2500 ₽</span>
                    </div>
                    <div class="service-item" role="listitem">
                        <span>Терапевт</span>
                    </div>
                </div>

                <div class="appointment-date">
                    <a href="#" class="date-link" aria-label="Выбрать дату 9 апреля">9 апреля (ср)</a>
                </div>

                <div class="time-slots" role="group" aria-label="Доступное время записи">
                    <button class="time-slot" aria-label="Записаться на 14:30">14:30</button>
                    <button class="time-slot" aria-label="Записаться на 15:20">15:20</button>
                    <button class="time-slot" aria-label="Записаться на 16:10">16:10</button>
                    <button class="time-slot" aria-label="Записаться на 17:00">17:00</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Функции для модального окна (оставлены, но не используются кнопкой "Записаться" напрямую)
function openAppointmentModal(button) {
    const modal = document.getElementById('appointmentModal');
    const card = button.closest('.specialist-card');

    // Получаем данные врача
    const doctorName = card.dataset.doctorName;
    const doctorPosition = card.dataset.specialization; // Используем specialization как позицию для примера
    const doctorImage = card.querySelector('.specialist-image img').src; // Получаем текущий src изображения
    // const services = JSON.parse(card.dataset.services || '[]'); // Если нужно передавать услуги в модальное окно

    // Обновляем информацию в модальном окне
    const doctorAvatar = modal.querySelector('.doctor-avatar');
    const doctorNameElement = modal.querySelector('.doctor-details h4');
    const doctorPositionElement = modal.querySelector('.doctor-details p');
    // const servicesContainer = modal.querySelector('.services-prices');

    if (doctorAvatar) doctorAvatar.src = doctorImage;
    if (doctorNameElement) doctorNameElement.innerHTML = doctorName;
    if (doctorPositionElement) doctorPositionElement.textContent = doctorPosition;

    // Обновляем список услуг (если используется)
    // if (servicesContainer && services.length > 0) {
    //     servicesContainer.innerHTML = services.map(service =>
    //         `<div class="service-item" role="listitem">
    //             <span>${service.name}</span>
    //             <span>${service.price}</span>
    //         </div>`
    //     ).join('');
    // }

    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden', 'false');

    // Фокус на первом интерактивном элементе
    const firstInput = modal.querySelector('input');
    if (firstInput) {
        firstInput.focus();
    }

    // Блокировка прокрутки страницы
    document.body.style.overflow = 'hidden';
}

function closeAppointmentModal() {
    const modal = document.getElementById('appointmentModal');
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');

    // Восстановление прокрутки страницы
    document.body.style.overflow = '';
}

// Закрытие модального окна при клике вне его
window.onclick = function(event) {
    const modal = document.getElementById('appointmentModal');
    if (event.target === modal) {
        closeAppointmentModal();
    }
}

// Закрытие модального окна по Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('appointmentModal');
        if (modal.style.display === 'flex') {
            closeAppointmentModal();
        }
    }
});

// Фильтрация специалистов
document.getElementById('gender-filter').addEventListener('change', filterSpecialists);
document.getElementById('specialization-filter').addEventListener('change', filterSpecialists);
document.getElementById('doctor-search').addEventListener('input', filterSpecialists);

function filterSpecialists() {
    const genderFilter = document.getElementById('gender-filter').value;
    const specializationFilter = document.getElementById('specialization-filter').value;
    const searchQuery = document.getElementById('doctor-search').value.toLowerCase();

    const cards = document.querySelectorAll('.specialist-card');
    let visibleCount = 0;

    cards.forEach(card => {
        const gender = card.dataset.gender;
        const specialization = card.dataset.specialization;
        const name = card.dataset.doctorName.toLowerCase(); // Используем data-doctor-name
        const position = card.querySelector('.specialist-position').textContent.toLowerCase();

        let show = true;

        if (genderFilter && gender !== genderFilter) show = false;
        // Проверяем, содержит ли категория врача выбранную специализацию
        if (specializationFilter && !specialization.includes(specializationFilter)) show = false;
        if (searchQuery && !name.includes(searchQuery) && !position.includes(searchQuery)) show = false;

        card.style.display = show ? 'block' : 'none';
        if (show) visibleCount++;
    });

    // Обновление счетчика результатов для скрин-ридеров
    const resultsAnnouncement = document.getElementById('search-results-announcement');
    if (resultsAnnouncement) {
        resultsAnnouncement.textContent = `Найдено ${visibleCount} врачей`;
    }
}

// Алфавитный фильтр
document.querySelectorAll('.alphabet-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        // Обновление состояния кнопок
        document.querySelectorAll('.alphabet-btn').forEach(b => {
            b.classList.remove('active');
            b.setAttribute('aria-pressed', 'false');
        });
        this.classList.add('active');
        this.setAttribute('aria-pressed', 'true');

        const letter = this.dataset.letter;
        const cards = document.querySelectorAll('.specialist-card');
        let visibleCount = 0;

        cards.forEach(card => {
            const name = card.dataset.doctorName; // Используем data-doctor-name
            const show = letter === '' || name.startsWith(letter);
            card.style.display = show ? 'block' : 'none';
            if (show) visibleCount++;
        });

        // Объявление результатов для скрин-ридеров
        const announcement = document.createElement('div');
        announcement.setAttribute('aria-live', 'polite');
        announcement.setAttribute('aria-atomic', 'true');
        announcement.className = 'sr-only';
        announcement.textContent = `Показано ${visibleCount} врачей`;
        document.body.appendChild(announcement);

        setTimeout(() => {
            document.body.removeChild(announcement);
        }, 1000);
    });
});

// Добавление скрытого элемента для объявления результатов поиска
document.addEventListener('DOMContentLoaded', function() {
    const announcement = document.createElement('div');
    announcement.id = 'search-results-announcement';
    announcement.setAttribute('aria-live', 'polite');
    announcement.setAttribute('aria-atomic', 'true');
    announcement.className = 'sr-only';
    document.body.appendChild(announcement);

    // Инициализация фильтров при загрузке страницы
    filterSpecialists();
});
</script>
{% endblock %}
